<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SnippetFlow | Extract & Render</title>
    <style>
      :root {
        --bg-color: #0f172a;
        --sidebar-color: #1e293b;
        --accent-color: #3b82f6;
        --accent-hover: #2563eb;
        --text-main: #e2e8f0;
        --text-dim: #94a3b8;
        --border: #334155;
        --font-mono: "ui-monospace", "SFMono-Regular", "Menlo", "Monaco",
          "Consolas", monospace;
      }

      body,
      html {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        overflow: hidden;
      }

      /* --- Layout --- */
      .app-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      header {
        padding: 0.75rem 1.5rem;
        background: var(--sidebar-color);
        border-bottom: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .main-layout {
        display: grid;
        grid-template-columns: 350px 1fr 350px;
        flex-grow: 1;
        overflow: hidden;
      }

      /* --- Panels --- */
      section {
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border);
        overflow: hidden;
      }

      .panel-header {
        padding: 10px 15px;
        background: rgba(0, 0, 0, 0.2);
        font-size: 0.8rem;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      /* Input Area */
      .input-area {
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex-grow: 1;
      }
      textarea {
        flex-grow: 1;
        background: #000;
        color: #22c55e;
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 10px;
        font-family: var(--font-mono);
        font-size: 0.85rem;
        resize: none;
      }

      /* Render Area (Middle) */
      .render-area {
        background: white;
        color: #1e293b;
        overflow-y: auto;
        padding: 2rem;
      }
      .render-content {
        max-width: 700px;
        margin: 0 auto;
        line-height: 1.6;
      }
      .render-content h1,
      .render-content h2 {
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 0.3em;
      }

      /* Snippets Area (Right) */
      .snippets-area {
        border-right: none;
        background: #111827;
      }
      .snippet-list {
        overflow-y: auto;
        padding: 10px;
        flex-grow: 1;
      }
      .snippet-card {
        background: var(--sidebar-color);
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 15px;
      }
      .snippet-card-header {
        padding: 5px 10px;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
      }
      .snippet-card-body {
        padding: 10px;
        font-family: var(--font-mono);
        font-size: 0.8rem;
        white-space: pre;
        overflow-x: auto;
        color: #cbd5e1;
      }

      /* --- Buttons & UI --- */
      .btn {
        padding: 6px 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 0.8rem;
        font-weight: 500;
      }
      .btn-blue {
        background: var(--accent-color);
        color: white;
      }
      .btn-blue:hover {
        background: var(--accent-hover);
      }
      .btn-ghost {
        background: transparent;
        color: var(--text-dim);
        border: 1px solid var(--border);
      }

      /* Download Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: var(--sidebar-color);
        padding: 20px;
        border-radius: 8px;
        width: 300px;
      }
      .modal-content input,
      .modal-content select {
        width: 100%;
        padding: 8px;
        margin: 10px 0;
        border-radius: 4px;
        border: 1px solid var(--border);
        background: var(--bg-color);
        color: white;
        box-sizing: border-box;
      }

      @media (max-width: 1000px) {
        .main-layout {
          grid-template-columns: 1fr;
          overflow-y: auto;
        }
        section {
          height: 500px;
          border-right: none;
          border-bottom: 1px solid var(--border);
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <header>
        <div style="font-weight: bold; font-size: 1.2rem">SnippetFlow</div>
        <div style="display: flex; gap: 15px; align-items: center">
          <label style="font-size: 0.8rem; color: var(--text-dim)">
            <input type="checkbox" id="autoPaste" /> Auto-Paste
          </label>
          <button class="btn btn-ghost" onclick="clearAll()">Clear All</button>
          <button class="btn btn-blue" onclick="processContent()">
            Manual Process
          </button>
        </div>
      </header>

      <main class="main-layout">
        <!-- PANE 1: INPUT -->
        <section>
          <div class="panel-header">
            Raw Input
            <input
              type="file"
              id="fileUpload"
              style="width: 150px; font-size: 0.6rem"
            />
          </div>
          <div class="input-area">
            <textarea
              id="mainInput"
              placeholder="Paste mixed Markdown and Code here..."
            ></textarea>
            <div style="display: flex; gap: 5px">
              <input
                type="text"
                id="searchTerm"
                placeholder="Search..."
                style="
                  flex-grow: 1;
                  background: #1e293b;
                  border: 1px solid var(--border);
                  color: white;
                  padding: 5px;
                  border-radius: 4px;
                "
              />
              <button class="btn btn-ghost" onclick="findText()">Find</button>
            </div>
          </div>
        </section>

        <!-- PANE 2: RENDER -->
        <section>
          <div class="panel-header">Document View</div>
          <div class="render-area">
            <div id="renderTarget" class="render-content"></div>
          </div>
        </section>

        <!-- PANE 3: SNIPPETS -->
        <section class="snippets-area">
          <div class="panel-header">
            Extracted Code
            <span
              id="blockCount"
              style="
                background: var(--accent-color);
                padding: 2px 6px;
                border-radius: 10px;
                font-size: 0.7rem;
              "
              >0</span
            >
          </div>
          <div id="snippetList" class="snippet-list"></div>
        </section>
      </main>
    </div>

    <!-- Download Modal -->
    <div id="dlModal" class="modal">
      <div class="modal-content">
        <h3 style="margin-top: 0">Download Snippet</h3>
        <label>Filename</label>
        <input type="text" id="dlFileName" value="snippet" />
        <label>Extension</label>
        <select id="dlExtension"></select>
        <div style="display: flex; gap: 10px; margin-top: 15px">
          <button
            class="btn btn-blue"
            style="flex: 1"
            onclick="executeDownload()"
          >
            Download
          </button>
          <button class="btn btn-ghost" style="flex: 1" onclick="closeModal()">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <script>
      const mainInput = document.getElementById("mainInput");
      const renderTarget = document.getElementById("renderTarget");
      const snippetList = document.getElementById("snippetList");
      const blockCount = document.getElementById("blockCount");
      const autoPaste = document.getElementById("autoPaste");

      // Extensions List
      const extensions = [
        { name: "Plain Text", ext: "txt" },
        { name: "JavaScript", ext: "js" },
        { name: "Python", ext: "py" },
        { name: "HTML", ext: "html" },
        { name: "CSS", ext: "css" },
        { name: "JSON", ext: "json" },
        { name: "Java", ext: "java" },
        { name: "C++", ext: "cpp" },
        { name: "Markdown", ext: "md" },
        { name: "SQL", ext: "sql" },
      ];

      let currentSnippetBlob = "";

      // --- Core Logic ---

      function processContent() {
        const val = mainInput.value;
        renderMarkdown(val);
        extractCode(val);
      }

      function renderMarkdown(text) {
        if (!text) {
          renderTarget.innerHTML = "";
          return;
        }

        let html = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        const lines = html.split("\n");

        const rendered = lines
          .map((line) => {
            if (line.startsWith("###"))
              return `<h3>${line.substring(3).trim()}</h3>`;
            if (line.startsWith("##"))
              return `<h2>${line.substring(2).trim()}</h2>`;
            if (line.startsWith("#"))
              return `<h1>${line.substring(1).trim()}</h1>`;
            if (line.trim() === "---") return `<hr>`;
            line = line.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
            if (line.trim().startsWith("* ") || line.trim().startsWith("- ")) {
              return `â€¢ ${line.trim().substring(2)}<br>`;
            }
            return line + "<br>";
          })
          .join("");

        renderTarget.innerHTML = rendered;
      }

      function extractCode(text) {
        snippetList.innerHTML = "";
        const regex = /```(?:\w+)?\n([\s\S]*?)\n```/g;
        let matches = [...text.matchAll(regex)];
        blockCount.textContent = matches.length;

        matches.forEach((match, i) => {
          const code = match[1];
          const div = document.createElement("div");
          div.className = "snippet-card";
          div.innerHTML = `
                <div class="snippet-card-header">
                    <span>Block ${i + 1}</span>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-ghost" style="padding:2px 6px; font-size:0.7rem" onclick="copySnip(\`${encodeURIComponent(
                          code
                        )}\`)">Copy</button>
                        <button class="btn btn-blue" style="padding:2px 6px; font-size:0.7rem" onclick="openDownloadModal(\`${encodeURIComponent(
                          code
                        )}\`)">Download</button>
                    </div>
                </div>
                <div class="snippet-card-body">${code}</div>
            `;
          snippetList.appendChild(div);
        });
      }

      // --- Utilities ---

      function copySnip(encoded) {
        navigator.clipboard.writeText(decodeURIComponent(encoded));
        alert("Copied to clipboard");
      }

      function clearAll() {
        mainInput.value = "";
        processContent();
      }

      // Auto-Paste logic
      mainInput.addEventListener("click", async () => {
        if (autoPaste.checked && !mainInput.value) {
          const text = await navigator.clipboard.readText();
          mainInput.value = text;
          processContent();
        }
      });

      // File Upload logic
      document
        .getElementById("fileUpload")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = (ev) => {
            mainInput.value = ev.target.result;
            processContent();
          };
          reader.readAsText(file);
        });

      // Search logic
      function findText() {
        const term = document.getElementById("searchTerm").value;
        const content = mainInput.value;
        const index = content.indexOf(term);
        if (index !== -1) {
          mainInput.focus();
          mainInput.setSelectionRange(index, index + term.length);
        }
      }

      // --- Download Handling ---

      function openDownloadModal(encoded) {
        currentSnippetBlob = decodeURIComponent(encoded);
        document.getElementById("dlModal").style.display = "flex";
      }

      function closeModal() {
        document.getElementById("dlModal").style.display = "none";
      }

      function executeDownload() {
        const name = document.getElementById("dlFileName").value;
        const ext = document.getElementById("dlExtension").value;
        const blob = new Blob([currentSnippetBlob], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${name}.${ext}`;
        a.click();
        closeModal();
      }

      // Init extension list
      const extSelect = document.getElementById("dlExtension");
      extensions.forEach((e) => {
        const opt = document.createElement("option");
        opt.value = e.ext;
        opt.textContent = e.name;
        extSelect.appendChild(opt);
      });

      // Live update when typing
      mainInput.addEventListener("input", processContent);
    </script>
  </body>
</html>